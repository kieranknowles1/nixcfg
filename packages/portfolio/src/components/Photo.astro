---
import assert from "assert"
import { Picture } from "astro:assets"

import ExifReader from 'exifreader'
import { readFileSync } from "fs"

interface Props {
  src: ImageMetadata
  alt: string
}

const {
  src,
  alt
} = Astro.props;

// HACK: Astro gives ImageMetadata.src in a weird format
const pattern = /\/@fs(.+)\?/
const srcFs = src.src.match(pattern)?.[1]
assert(srcFs, "srcFs is undefined")

const exifData = await ExifReader.load(srcFs)

type Tag = ExifReader.XmpTag | ExifReader.NumberTag | ExifReader.NumberArrayTag | undefined

function exifField(field: Tag, label: string) {
  if (field == undefined) return undefined

  return `${label}${field.description}`
}
console.log(exifData)

const fields = [
  exifField(exifData.ISOSpeedRatings, "ISO "),
  exifField(exifData.ExposureTime, ""),
  exifField(exifData.ApertureValue, "f/"),
  exifField(exifData.FocalLength, ""),
]

---
<figure>
  <Picture
    src={src}
    alt={alt}
  />
  <figcaption>
    {fields.filter(f => f !== undefined).join(", ")}
  </figcaption>
</figure>
