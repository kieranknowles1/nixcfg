---
import assert from "assert"
import { Picture } from "astro:assets"
import { Icon } from "astro-icon/components"

import ExifReader from 'exifreader'

interface Props {
  src: ImageMetadata
  alt: string
}

const {
  src,
  alt
} = Astro.props;

// HACK: Astro gives ImageMetadata.src in a weird format
const pattern = /\/@fs(.+)\?/
const srcFs = src.src.match(pattern)?.[1]
assert(srcFs, "srcFs is undefined")

const exifData = await ExifReader.load(srcFs)

interface ExifField {
  icon: string
  value?: string
}

console.log(exifData)

const fields: ExifField[] = [
  { icon: "material-symbols:exposure", value: exifData.ISOSpeedRatings && `ISO ${exifData.ISOSpeedRatings?.description}`},
  { icon: "material-symbols:timer", value: exifData.ExposureTime?.description },
  { icon: "material-symbols:camera", value: exifData.FNumber?.description },
  { icon: "material-symbols:photo-camera", value: exifData.FocalLength?.description },
]

---
<figure>
  <Picture
    src={src}
    alt={alt}
  />
  <figcaption>
    {fields.filter(f => f.value !== undefined).map(f => <>
      <Icon name={f.icon} /> {f.value}
    </>)}
  </figcaption>
</figure>
